<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L & H ç”œèœœäº‘ç«¯å°å±‹</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary-color: #ff6b81; --bg-color: #fff5f6; --card-bg: #ffffff; --blue-text: #1976d2; --pink-text: #c2185b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); margin: 0; color: #444; padding-bottom: 50px; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* æŒ‘æˆ˜å¡ç‰‡ */
        .challenge-card { background: linear-gradient(135deg, #fff9db 0%, #fff3bf 100%); border: 1px dashed #fab005; border-radius: 15px; padding: 15px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .challenge-tag { background: #fab005; color: white; padding: 2px 10px; border-radius: 10px; font-size: 11px; font-weight: bold; margin-bottom: 8px; display: inline-block; }
        .challenge-text { font-size: 15px; color: #856404; font-weight: 500; }

        /* ç”Ÿæ—¥å¡ç‰‡ */
        .birthday-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .birthday-card { flex: 1; background: white; padding: 12px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-bottom: 3px solid #eee; }
        .b-yy { border-color: var(--primary-color); }
        .b-sl { border-color: #1976d2; }
        .b-name { font-size: 11px; color: #999; margin-bottom: 4px; }
        .b-days { font-size: 14px; font-weight: bold; color: #444; }
        .b-days span { color: var(--primary-color); font-size: 20px; }

        /* æ—¥å¿—ã€è®¡æ—¶å™¨ç­‰åŸæœ‰æ ·å¼ */
        .log-container { background: white; border-radius: 15px; padding: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); font-size: 12px; max-height: 120px; overflow-y: auto; }
        .log-item { padding: 4px 8px; margin-bottom: 4px; border-radius: 6px; }
        .log-lsl { background: #e3f2fd; color: var(--blue-text); border-left: 4px solid #1976d2; }
        .log-hyy { background: #fce4ec; color: var(--pink-text); border-left: 4px solid #c2185b; }
        .timer-card { background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%); color: white; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 10px 20px rgba(255,117,140,0.3); margin-bottom: 20px; }
        #timer { font-family: monospace; font-size: 1.1rem; font-weight: bold; margin-top: 10px; }
        .heart-interaction { background: white; border-radius: 20px; padding: 15px; text-align: center; margin-bottom: 20px; position: relative; height: 80px; display: flex; justify-content: center; align-items: center; gap: 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .heart { font-size: 40px; transition: 0.5s; filter: grayscale(1); opacity: 0.3; }
        .heart.active { filter: grayscale(0); opacity: 1; transform: scale(1.1); }
        .heart.bump { transform: translateX(25px) scale(1.3); }
        .heart.bump-reverse { transform: translateX(-25px) scale(1.3); }
        .mood-bar { display: flex; justify-content: space-around; background: white; padding: 10px; border-radius: 50px; margin-bottom: 20px; }
        .mood-item { cursor: pointer; font-size: 22px; opacity: 0.4; transition: 0.3s; }
        .mood-item.selected { opacity: 1; transform: scale(1.3); }
        .card { background: white; border-radius: 15px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .user-tag { background: #ffeaa7; color: #d35400; padding: 2px 8px; border-radius: 5px; font-weight: bold; font-size: 12px; }
        .actions { border-top: 1px solid #f5f5f5; margin-top: 12px; padding-top: 10px; display: flex; gap: 20px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 14px; color: #666; display: flex; align-items: center; gap: 4px; }
        .action-btn.liked { color: var(--primary-color); }
        .comment-box { background: #fcfcfc; border-radius: 10px; padding: 10px; margin-top: 10px; font-size: 13px; }
        .comment-item { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        .btn { background: var(--primary-color); color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        textarea { width: 100%; border: none; background: #f9f9f9; padding: 10px; border-radius: 10px; min-height: 80px; margin-bottom: 10px; box-sizing: border-box; font-size: 15px; outline: none; }
        #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:1000; justify-content:center; align-items:center; }
    </style>
</head>
<body>
    <div id="loading">ğŸ’ æ­£åœ¨åŒæ­¥å›å¿†...</div>

    <div id="login-page" style="height:100vh; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:40px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.1); width:280px; text-align:center;">
            <h2 style="color:var(--primary-color)">ğŸ’– L & H å°å±‹</h2>
            <input type="text" id="username" placeholder="è´¦å·" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #eee;">
            <input type="password" id="password" placeholder="å¯†ç " style="width:100%; padding:12px; margin-bottom:20px; border-radius:10px; border:1px solid #eee;">
            <button class="btn" style="width:100%" onclick="login()">å¼€å¯å›å¿†</button>
        </div>
    </div>

    <div id="main-page" style="display:none;">
        <div class="container">
            <header style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="font-weight:bold; color:var(--primary-color)">ğŸ  L&Hçš„äº‘ç«¯ç©ºé—´</span>
                <a href="javascript:logout()" style="font-size:12px; color:#999; text-decoration:none;">é€€å‡º</a>
            </header>

            <div class="challenge-card">
                <div class="challenge-tag">æœ¬å‘¨ç”œèœœä»»åŠ¡</div>
                <div id="challenge-text" class="challenge-text">åŠ è½½ä¸­...</div>
            </div>

            <div class="birthday-container">
                <div class="birthday-card b-yy">
                    <div class="b-name">æ´‹æ´‹ç”Ÿæ—¥ (12.12)</div>
                    <div class="b-days" id="yy-countdown">è·ç”Ÿæ—¥ <span>-</span> å¤©</div>
                </div>
                <div class="birthday-card b-sl">
                    <div class="b-name">å°‘é¾™ç”Ÿæ—¥ (å†œ10.26)</div>
                    <div class="b-days" id="sl-countdown">è·ç”Ÿæ—¥ <span>-</span> å¤©</div>
                </div>
            </div>

            <div id="login-logs" class="log-container"></div>

            <div class="timer-card">
                <div style="font-size: 13px; opacity: 0.9;">åœ¨ä¸€èµ·çš„ç¬¬</div>
                <div id="timer">æ­£åœ¨è®¡ç®—...</div>
            </div>

            <div class="mood-bar">
                <span class="mood-item" id="m-â˜€ï¸" onclick="setMood('â˜€ï¸')">â˜€ï¸</span>
                <span class="mood-item" id="m-â˜ï¸" onclick="setMood('â˜ï¸')">â˜ï¸</span>
                <span class="mood-item" id="m-ğŸŒ§ï¸" onclick="setMood('ğŸŒ§ï¸')">ğŸŒ§ï¸</span>
                <span class="mood-item" id="m-ğŸŒˆ" onclick="setMood('ğŸŒˆ')">ğŸŒˆ</span>
                <span class="mood-item" id="m-â„ï¸" onclick="setMood('â„ï¸')">â„ï¸</span>
            </div>

            <div class="heart-interaction">
                <div id="heart-lsl" class="heart">â¤ï¸</div>
                <div id="bump-msg" style="position:absolute; top:2px; font-size:12px; color:var(--primary-color); font-weight:bold; display:none;">ç¢°åˆ°äº†ï¼ğŸ’</div>
                <div id="heart-hyy" class="heart">â¤ï¸</div>
            </div>

            <div class="card">
                <textarea id="post-content" placeholder="è¿™ä¸€åˆ»åœ¨æƒ³ä»€ä¹ˆï¼Ÿ"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <input type="file" id="file-input" style="display:none" onchange="document.getElementById('file-name').innerText='å·²é€‰æ–‡ä»¶'">
                    <button onclick="document.getElementById('file-input').click()" style="background:none; border:none; color:#999; font-size:12px; cursor:pointer;">ğŸ“· ç…§ç‰‡/è§†é¢‘</button>
                    <span id="file-name" style="font-size:10px; color:#ccc"></span>
                    <button class="btn" onclick="publish()">å‘å¸ƒ</button>
                </div>
            </div>

            <div id="feed"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://srtqliafewjgkzpwdgaf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gLVqDoLokrtzn241LoTEcQ_Th6NwupU';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // æ ¸å¿ƒä¿®æ”¹ 1: æ”¹ä¸º sessionStorageï¼Œé¡µé¢åˆ·æ–°å³ä¸¢å¤±ï¼Œéœ€è¦é‡ç™»
        let currentUser = sessionStorage.getItem('love_user');
        const START_DATE = new Date('2025-12-20T00:00:00');
        const challenges = ["åˆ†äº«ä¸€å¼ æ­¤åˆ»çœ‹åˆ°çš„å¤©ç©º","ç»™TAè¯´ä¸€å¥æ²¡è¯´å‡ºå£çš„å¤¸å¥–","æœ¬å‘¨ä¸€èµ·æ¢ä¸€å¯¹æƒ…ä¾£å¤´åƒ","åˆ†äº«ä¸€é¦–æœ€è¿‘å¾ªç¯çš„æ­Œ","åˆ†äº«ä¸€ä¸ªæœ¬å‘¨å¼€å¿ƒç¬é—´","å†™ä¸€å¼ çº¸æ¡æ‹ç»™TA","è§†é¢‘é€šè¯10åˆ†é’Ÿ"];

        const SL_BIRTHDAYS = { 2025: "2025-12-15", 2026: "2026-12-05", 2027: "2027-11-24" };

        // æ ¸å¿ƒä¿®æ”¹ 2: é¡µé¢ä¸€æ‰“å¼€å…ˆæ˜¾ç¤ºç™»å½•é¡µï¼Œå³ä½¿æœ‰ sessionStorage ä¹Ÿè¦é‡ç™»ï¼ˆå¦‚éœ€å®Œå…¨å¼ºåˆ¶ï¼Œå¯å»æ‰ onload åˆ¤æ–­ï¼‰
        window.onload = () => { 
            sessionStorage.clear(); // å¼ºåˆ¶æ¯æ¬¡æ‰“å¼€/åˆ·æ–°éƒ½æ¸…ç©ºä¼šè¯
            document.getElementById('login-page').style.display = 'flex';
        };

        function initDashboard() {
            const now = new Date();
            const year = now.getFullYear();
            let yyNext = new Date(year, 11, 12);
            if (now > yyNext) yyNext = new Date(year + 1, 11, 12);
            document.querySelector('#yy-countdown span').innerText = Math.ceil((yyNext - now) / 86400000);

            let slNext = new Date(SL_BIRTHDAYS[year]);
            if (now > slNext) slNext = new Date(SL_BIRTHDAYS[year + 1]);
            document.querySelector('#sl-countdown span').innerText = Math.ceil((slNext - now) / 86400000);

            const weekIndex = (now.getMonth() + Math.ceil(now.getDate()/7)) % challenges.length;
            document.getElementById('challenge-text').innerText = challenges[weekIndex];
        }

        async function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if((u === 'liushaolong' || u === 'huyangyang') && p === 'hyy520lsl') {
                currentUser = u; 
                sessionStorage.setItem('love_user', u); // å­˜å‚¨åˆ°ä¼šè¯
                await _supabase.from('login_logs').insert([{ author: u }]);
                showMain();
            } else { alert('è´¦å·æˆ–å¯†ç ä¸å¯¹å“¦'); }
        }

        async function showMain() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            initDashboard();
            await Promise.all([updateHeartUI(), fetchLogs(), fetchData()]);
        }

        // è®¡æ—¶å™¨
        setInterval(() => {
            const diff = new Date() - START_DATE;
            document.getElementById('timer').innerText = `${Math.floor(diff/86400000)}å¤© ${Math.floor((diff/3600000)%24)}æ—¶ ${Math.floor((diff/60000)%60)}åˆ† ${Math.floor((diff/1000)%60)}ç§’`;
        }, 1000);

        async function fetchLogs() {
            const { data } = await _supabase.from('login_logs').select('*').order('created_at', { ascending: false }).limit(10);
            document.getElementById('login-logs').innerHTML = (data || []).map(log => {
                const isLsl = log.author === 'liushaolong';
                return `<div class="log-item ${isLsl ? 'log-lsl' : 'log-hyy'}">ğŸ“Œ ${isLsl ? 'å°‘é¾™' : 'æ´‹æ´‹'} åœ¨ ${new Date(log.created_at).toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})} æ¥è¿‡~</div>`;
            }).join('');
        }

        async function setMood(emoji) {
            const today = new Date().toISOString().split('T')[0];
            await _supabase.from('mood_sync').upsert({ username: currentUser, mood: emoji, last_heartbeat: today }, { onConflict: 'username,last_heartbeat' });
            updateHeartUI();
        }

        async function updateHeartUI() {
            const today = new Date().toISOString().split('T')[0];
            const { data } = await _supabase.from('mood_sync').select('*').eq('last_heartbeat', today);
            const lsl = data?.find(d => d.username === 'liushaolong'), hyy = data?.find(d => d.username === 'huyangyang');
            const hl = document.getElementById('heart-lsl'), hh = document.getElementById('heart-hyy');
            document.querySelectorAll('.mood-item').forEach(el => el.classList.remove('selected'));
            if(lsl) { hl.classList.add('active'); hl.innerText = lsl.mood; if(currentUser==='liushaolong') document.getElementById(`m-${lsl.mood}`).classList.add('selected'); }
            if(hyy) { hh.classList.add('active'); hh.innerText = hyy.mood; if(currentUser==='huyangyang') document.getElementById(`m-${hyy.mood}`).classList.add('selected'); }
            if(lsl && hyy) { hl.classList.add('bump'); hh.classList.add('bump-reverse'); document.getElementById('bump-msg').style.display='block'; }
        }

        async function publish() {
            const content = document.getElementById('post-content').value, file = document.getElementById('file-input').files[0];
            if(!content && !file) return;
            document.getElementById('loading').style.display = 'flex';
            let mediaUrl = null, mediaPath = null;
            if(file) {
                mediaPath = `${Date.now()}_${file.name}`;
                await _supabase.storage.from('attachments').upload(mediaPath, file);
                const { data } = _supabase.storage.from('attachments').getPublicUrl(mediaPath);
                mediaUrl = data.publicUrl;
            }
            await _supabase.from('posts').insert([{ author: currentUser, content, media_url: mediaUrl, media_path: mediaPath, type: file?.type.includes('video')?'video':'image' }]);
            location.reload();
        }

        async function toggleLike(postId) {
            const { data } = await _supabase.from('likes').select('*').eq('post_id', postId).eq('author', currentUser);
            if (data?.length > 0) await _supabase.from('likes').delete().eq('post_id', postId).eq('author', currentUser);
            else await _supabase.from('likes').insert([{ post_id: postId, author: currentUser }]);
            fetchData();
        }

        async function addComment(postId) {
            const input = document.getElementById(`in-${postId}`);
            if(!input.value) return;
            await _supabase.from('comments').insert([{ post_id: postId, author: currentUser, content: input.value }]);
            input.value = ''; fetchData();
        }

        async function deletePost(id, path) {
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                if(path) await _supabase.storage.from('attachments').remove([path]);
                await _supabase.from('posts').delete().eq('id', id);
                fetchData();
            }
        }

        async function fetchData() {
            const [{ data: posts }, { data: likes }, { data: comments }] = await Promise.all([
                _supabase.from('posts').select('*').order('created_at', { ascending: false }),
                _supabase.from('likes').select('*'),
                _supabase.from('comments').select('*').order('created_at', { ascending: true })
            ]);
            const feed = document.getElementById('feed');
            feed.innerHTML = (posts || []).map(p => {
                const pLikes = (likes || []).filter(l => l.post_id === p.id);
                const isLiked = pLikes.some(l => l.author === currentUser);
                const pComments = (comments || []).filter(c => c.post_id === p.id);
                return `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span class="user-tag">${p.author==='liushaolong'?'å°‘é¾™':'æ´‹æ´‹'}</span>
                        <span style="font-size:11px; color:#ccc;">${new Date(p.created_at).toLocaleString()}</span>
                    </div>
                    <div style="white-space:pre-wrap; font-size:15px; margin-bottom:10px;">${p.content}</div>
                    ${p.media_url ? (p.type==='video'?`<video src="${p.media_url}" controls style="width:100%; border-radius:10px;"></video>`:`<img src="${p.media_url}" style="width:100%; border-radius:10px;">`) : ''}
                    <div class="actions">
                        <span class="action-btn ${isLiked?'liked':''}" onclick="toggleLike(${p.id})">${isLiked?'â¤ï¸':'ğŸ¤'} ${pLikes.length||''}</span>
                        <span class="action-btn">ğŸ’¬ ${pComments.length||''}</span>
                        <button onclick="deletePost(${p.id},'${p.media_path||''}')" style="margin-left:auto; border:none; background:none; color:#ddd; font-size:10px; cursor:pointer;">åˆ é™¤</button>
                    </div>
                    <div class="comment-box">
                        ${pComments.map(c => `<div class="comment-item"><span class="comment-user">${c.author==='liushaolong'?'å°‘é¾™':'æ´‹æ´‹'}:</span> ${c.content}</div>`).join('')}
                        <div class="comment-in-group">
                            <input type="text" id="in-${p.id}" placeholder="å†™ä¸‹è¯„è®º...">
                            <button class="btn" style="padding:2px 10px; font-size:11px;" onclick="addComment(${p.id})">å‘é€</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        function logout() { sessionStorage.clear(); location.reload(); }
    </script>
</body>
</html>